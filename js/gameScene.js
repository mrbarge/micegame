import{GAME_CONFIG}from"./gameConfig.js";import{GameBoard}from"./gameBoard.js";import{GameLogic}from"./gameLogic.js";export class GameScene extends Phaser.Scene{constructor(){super({key:"GameScene"}),this.gameBoard=null,this.gameLogic=null,this.cellGraphics=[]}preload(){this.createWallGraphic(),this.createMouseGraphics()}createWallGraphic(){const e=this.add.graphics();e.fillStyle(9127187),e.fillRect(0,0,GAME_CONFIG.CELL_SIZE-2,GAME_CONFIG.CELL_SIZE-2),e.lineStyle(1,6636321);for(let t=0;t<GAME_CONFIG.CELL_SIZE;t+=8)e.moveTo(0,t),e.lineTo(GAME_CONFIG.CELL_SIZE-2,t);for(let t=0;t<GAME_CONFIG.CELL_SIZE;t+=12)e.moveTo(t,0),e.lineTo(t,GAME_CONFIG.CELL_SIZE-2);e.strokePath(),e.generateTexture("wall",GAME_CONFIG.CELL_SIZE-2,GAME_CONFIG.CELL_SIZE-2),e.destroy()}createMouseGraphics(){const e=this.add.graphics();e.fillStyle(3447003),e.fillCircle(GAME_CONFIG.CELL_SIZE/2,GAME_CONFIG.CELL_SIZE/2,12),e.fillCircle(GAME_CONFIG.CELL_SIZE/2-6,GAME_CONFIG.CELL_SIZE/2-8,4),e.fillCircle(GAME_CONFIG.CELL_SIZE/2+6,GAME_CONFIG.CELL_SIZE/2-8,4),e.fillStyle(0),e.fillCircle(GAME_CONFIG.CELL_SIZE/2-4,GAME_CONFIG.CELL_SIZE/2-2,2),e.fillCircle(GAME_CONFIG.CELL_SIZE/2+4,GAME_CONFIG.CELL_SIZE/2-2,2),e.generateTexture("blueMouse",GAME_CONFIG.CELL_SIZE,GAME_CONFIG.CELL_SIZE),e.destroy();const t=this.add.graphics();t.fillStyle(15158332),t.fillCircle(GAME_CONFIG.CELL_SIZE/2,GAME_CONFIG.CELL_SIZE/2,12),t.fillCircle(GAME_CONFIG.CELL_SIZE/2-6,GAME_CONFIG.CELL_SIZE/2-8,4),t.fillCircle(GAME_CONFIG.CELL_SIZE/2+6,GAME_CONFIG.CELL_SIZE/2-8,4),t.fillStyle(0),t.fillCircle(GAME_CONFIG.CELL_SIZE/2-4,GAME_CONFIG.CELL_SIZE/2-2,2),t.fillCircle(GAME_CONFIG.CELL_SIZE/2+4,GAME_CONFIG.CELL_SIZE/2-2,2),t.generateTexture("redMouse",GAME_CONFIG.CELL_SIZE,GAME_CONFIG.CELL_SIZE),t.destroy()}create(){this.gameBoard=new GameBoard,this.gameLogic=new GameLogic(this.gameBoard),this.createGrid(),this.createColumnControls(),this.gameLogic.updateUI(),window.gameScene=this}createGrid(){this.cellGraphics&&this.cellGraphics.forEach(e=>{e.forEach(e=>{e.sprite&&e.sprite.destroy(),e.destroy()})}),this.cellGraphics=[];for(let e=0;e<GAME_CONFIG.GRID_HEIGHT;e++){this.cellGraphics[e]=[];for(let t=0;t<GAME_CONFIG.GRID_WIDTH;t++){const E=50+t*GAME_CONFIG.CELL_SIZE,G=75+e*GAME_CONFIG.CELL_SIZE,l=this.add.rectangle(E,G,GAME_CONFIG.CELL_SIZE-1,GAME_CONFIG.CELL_SIZE-1,GAME_CONFIG.COLORS.EMPTY);l.setStrokeStyle(1,GAME_CONFIG.COLORS.GRID_LINE),l.sprite=null,this.cellGraphics[e][t]=l}}this.updateGridDisplay()}updateGridDisplay(){for(let e=0;e<GAME_CONFIG.GRID_HEIGHT;e++)for(let t=0;t<GAME_CONFIG.GRID_WIDTH;t++){const E=this.gameBoard.getCellType(e,t),G=this.cellGraphics[e][t],l=50+t*GAME_CONFIG.CELL_SIZE,C=75+e*GAME_CONFIG.CELL_SIZE;switch(G.sprite&&(G.sprite.destroy(),G.sprite=null),E){case GAME_CONFIG.CELL_TYPES.WALL:G.setFillStyle(GAME_CONFIG.COLORS.EMPTY),G.sprite=this.add.image(l,C,"wall");break;case GAME_CONFIG.CELL_TYPES.BLUE_MOUSE:G.setFillStyle(GAME_CONFIG.COLORS.EMPTY),G.sprite=this.add.image(l,C,"blueMouse");break;case GAME_CONFIG.CELL_TYPES.RED_MOUSE:G.setFillStyle(GAME_CONFIG.COLORS.EMPTY),G.sprite=this.add.image(l,C,"redMouse");break;default:G.setFillStyle(GAME_CONFIG.COLORS.EMPTY)}}}createColumnControls(){const e=document.getElementById("column-controls");e.innerHTML="";const t=GAME_CONFIG.CELL_SIZE,E=GAME_CONFIG.GRID_HEIGHT*t;for(let G=0;G<GAME_CONFIG.GRID_WIDTH;G++){const l=35+G*t+t/2,C=l-t/2,s=document.createElement("button");s.className="column-btn",s.id=`up-${G}`,s.textContent="↑",s.style.left=`${C}px`,s.style.top=62-t-8+"px",s.onclick=()=>this.handleColumnMove(G,1),e.appendChild(s);const i=document.createElement("button");i.className="column-btn",i.id=`down-${G}`,i.textContent="↓",i.style.left=`${C}px`,i.style.top=`${62+E+8}px`,i.onclick=()=>this.handleColumnMove(G,-1),e.appendChild(i);const I=document.createElement("div");I.className="column-number",I.textContent=G+1,I.style.left=l-10+"px",I.style.top=`${62+E+t+16}px`,e.appendChild(I)}}async handleColumnMove(e,t){await this.gameLogic.makeMove(e,t)}animateColumnMovement(e,t){return new Promise(E=>{const G=50+e*GAME_CONFIG.CELL_SIZE,l=[];for(let t=0;t<GAME_CONFIG.GRID_HEIGHT;t++){const E=this.gameBoard.getCellType(t,e),C=75+t*GAME_CONFIG.CELL_SIZE;let s=null;switch(E){case GAME_CONFIG.CELL_TYPES.WALL:s=this.add.image(G,C,"wall");break;case GAME_CONFIG.CELL_TYPES.BLUE_MOUSE:s=this.add.image(G,C,"blueMouse");break;case GAME_CONFIG.CELL_TYPES.RED_MOUSE:s=this.add.image(G,C,"redMouse");break;default:s=this.add.rectangle(G,C,GAME_CONFIG.CELL_SIZE-1,GAME_CONFIG.CELL_SIZE-1,2899536,0)}s&&(s.setDepth(1e3),l.push(s))}const C=[];for(let e=0;e<GAME_CONFIG.GRID_HEIGHT;e++){const G=l[e];let s;s=1===t?0===e?GAME_CONFIG.GRID_HEIGHT-1:e-1:e===GAME_CONFIG.GRID_HEIGHT-1?0:e+1;const i=75+s*GAME_CONFIG.CELL_SIZE;this.tweens.add({targets:G,y:i,duration:400,ease:"Power2",onComplete:()=>{C.push("complete"),C.length===GAME_CONFIG.GRID_HEIGHT&&(l.forEach(e=>e.destroy()),E())}})}})}animateMouseMovement(e,t,E,G,l){return new Promise(C=>{const s=50+t*GAME_CONFIG.CELL_SIZE,i=75+e*GAME_CONFIG.CELL_SIZE,I=50+G*GAME_CONFIG.CELL_SIZE,a=75+E*GAME_CONFIG.CELL_SIZE,_=this.cellGraphics[e][t],o=_.sprite;if(o)_.sprite=null,this.tweens.add({targets:o,x:I,y:a,duration:300,ease:"Power2",onComplete:()=>{o.destroy(),this.updateGridDisplay(),C()}});else{const e=l===GAME_CONFIG.CELL_TYPES.BLUE_MOUSE?"blueMouse":"redMouse",t=this.add.image(s,i,e);this.tweens.add({targets:t,x:I,y:a,duration:300,ease:"Power2",onComplete:()=>{this.updateGridDisplay(),C()}})}})}}